oprules
----
- name: skip column removal ops on relation drop
  from: column-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $column[Type] = '*scpb.Column'
    - $relation[DescID] = $relation-id
    - $column[DescID] = $relation-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTargetNode($column, $column-target, $column-node)
    - $column-target[TargetStatus] = ABSENT
    - $column-node[CurrentStatus] IN [PUBLIC, WRITE_ONLY]
- name: skip column dependents removal ops on relation drop
  from: column-dep-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $column[Type] = '*scpb.Column'
    - $column-dep[Type] = '*scpb.ColumnName'
    - $relation[DescID] = $relation-id
    - $column[DescID] = $relation-id
    - $column-dep[DescID] = $relation-id
    - $column[ColumnID] = $column-id
    - $column-dep[ColumnID] = $column-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTarget($column, $column-target)
    - $column-target[TargetStatus] = ABSENT
    - joinTargetNode($column-dep, $column-dep-target, $column-dep-node)
    - $column-dep-target[TargetStatus] = ABSENT
- name: skip index removal ops on relation drop
  from: index-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $relation[DescID] = $relation-id
    - $index[DescID] = $relation-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTargetNode($index, $index-target, $index-node)
    - $index-target[TargetStatus] = ABSENT
- name: skip index dependents removal ops on relation drop
  from: index-dep-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $index[Type] IN ['*scpb.PrimaryIndex', '*scpb.SecondaryIndex']
    - $index-dep[Type] IN ['*scpb.IndexName', '*scpb.IndexPartitioning']
    - $relation[DescID] = $relation-id
    - $index[DescID] = $relation-id
    - $index-dep[DescID] = $relation-id
    - $index[IndexID] = $index-id
    - $index-dep[IndexID] = $index-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTarget($index, $index-target)
    - $index-target[TargetStatus] = ABSENT
    - joinTargetNode($index-dep, $index-dep-target, $index-dep-node)
    - $index-dep-target[TargetStatus] = ABSENT
- name: skip constraint removal ops on relation drop
  from: constraint-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $constraint[Type] = '*scpb.UniqueWithoutIndexConstraint'
    - $relation[DescID] = $relation-id
    - $constraint[DescID] = $relation-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTargetNode($constraint, $constraint-target, $constraint-node)
    - $constraint-target[TargetStatus] = ABSENT
- name: skip constraint dependents removal ops on relation drop
  from: constraint-dep-node
  query:
    - $relation[Type] IN ['*scpb.Table', '*scpb.View']
    - $constraint[Type] IN ['*scpb.UniqueWithoutIndexConstraint', '*scpb.CheckConstraint', '*scpb.ForeignKeyConstraint']
    - $constraint-dep[Type] = '*scpb.ConstraintName'
    - $relation[DescID] = $relation-id
    - $constraint[DescID] = $relation-id
    - $constraint-dep[DescID] = $relation-id
    - $constraint[ConstraintID] = $constraint-id
    - $constraint-dep[ConstraintID] = $constraint-id
    - joinTarget($relation, $relation-target)
    - $relation-target[TargetStatus] = ABSENT
    - joinTarget($constraint, $constraint-target)
    - $constraint-target[TargetStatus] = ABSENT
    - joinTargetNode($constraint-dep, $constraint-dep-target, $constraint-dep-node)
    - $constraint-dep-target[TargetStatus] = ABSENT
- name: skip element removal ops on descriptor drop
  from: dep-node
  query:
    - $desc[Type] IN ['*scpb.Database', '*scpb.Schema', '*scpb.Table', '*scpb.View', '*scpb.Sequence', '*scpb.AliasType', '*scpb.EnumType']
    - $dep[Type] IN ['*scpb.ColumnFamily', '*scpb.Owner', '*scpb.UserPrivileges']
    - $desc[DescID] = $desc-id
    - $dep[DescID] = $desc-id
    - joinTarget($desc, $desc-target)
    - $desc-target[TargetStatus] = ABSENT
    - joinTargetNode($dep, $dep-target, $dep-node)
    - $dep-target[TargetStatus] = ABSENT
- name: skip table comment removal ops on descriptor drop
  from: dep-node
  query:
    - $desc[Type] IN ['*scpb.Table', '*scpb.View', '*scpb.Sequence']
    - $dep[Type] IN ['*scpb.ColumnComment', '*scpb.IndexComment', '*scpb.ConstraintComment', '*scpb.TableComment']
    - $desc[DescID] = $desc-id
    - $dep[DescID] = $desc-id
    - joinTarget($desc, $desc-target)
    - $desc-target[TargetStatus] = ABSENT
    - joinTargetNode($dep, $dep-target, $dep-node)
    - $dep-target[TargetStatus] = ABSENT
