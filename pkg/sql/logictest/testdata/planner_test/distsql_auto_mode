# LogicTest: fakedist

#
# Tests that verify DistSQL support and auto mode determination.
# The cluster size or distsql mode aren't important for these tests.
#

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT)

# Verify that EXPLAIN (DISTSQL) hides the JSON column by default (#21089)
query BT colnames
EXPLAIN (DISTSQL) SELECT 1
----
automatic  url
false      https://cockroachdb.github.io/distsqlplan/decode.html#eJyMj81KxDAUhfc-RTirGQjY7uTu_JlFodRxWkSQLkpzGYs1qbkJCKXvLpMsxIXg8pyTfB93hXzOIBxejvVt1ajdQ9V27VO9V-2hPtx3qoSGdYab4YMF9IoSvcbi3cgizl-qNT2ozBeo0JjsEsOl7jVG5xm0IkxhZhCehzmyXBfQMByGaU7EQt2pXaHGt2jfZQ-NE1vDnlRJRFXT3aDfNFwMP2AJw5lBxab_Lz-xLM4K_5L_Te412Jw5Hygu-pGP3o1Jk-Nj-pcKwxLyWuZQ2Txt_Xb1HQAA__8KVHFX

# Check the JSON column is still there, albeit hidden.
query T colnames
SELECT json FROM [EXPLAIN (DISTSQL) SELECT * FROM kv] WHERE false
----
json

# Full table scan - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv]
----
true

# Partial scan - don't distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv WHERE k=1]
----
false

# Partial scan - don't distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv WHERE k>1]
----
false

# Partial scan with filter - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv WHERE k>1 AND v=1]
----
true

# Sort - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv WHERE k>1 ORDER BY v]
----
true

# Aggregation - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT k, sum(v) FROM kv WHERE k>1 GROUP BY k]
----
true

# Hard limit in scan - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv LIMIT 1]
----
true

# Soft limit in scan - don't distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv UNION SELECT * FROM kv LIMIT 1]
----
false

# Limit after sort - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv WHERE k>1 ORDER BY v LIMIT 1]
----
true

# Limit after aggregation - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT k, sum(v) FROM kv WHERE k>1 GROUP BY k LIMIT 1]
----
true

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT)

# Join - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv NATURAL JOIN kw]
----
true

# Join with span - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM kv NATURAL JOIN kw WHERE k=1]
----
true

statement ok
CREATE TABLE abc (a INT PRIMARY KEY, b INT, c INT, INDEX b (b))

# Index join - don't distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM abc WHERE b=1]
----
false

# Index join with filter on result - don't distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM abc WHERE b>1 AND c%2=0]
----
false

# Index join with filter on index scan - distribute.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT * FROM abc WHERE b=1 AND a%2=0]
----
true

# OID cast - don't distribute (#22249).
query BT
EXPLAIN (DISTSQL) SELECT t1.a FROM abc t1 INNER JOIN abc t2 on t1.a::REGCLASS = t2.a::REGCLASS;
----
false  https://cockroachdb.github.io/distsqlplan/decode.html#eJyskUGr2zAMx-_7FEanDbw1dm-GQUqXbSlZ0iU9DEYObiy6QBpntgMbJd99xIG1KX2v9PGO-ks_SX_pBPZ3AwKiH9tkFafk7ae42BXfk3ekiJJovSOOfZDkc559I3JfkVVBHCNxmkY52WRx-l_kJEt9rRB59GWdrIqCfCSOXwpAodUKU3lEC-InMCgpdEZXaK02o3TyBbH6AyKgULdd70a5pFBpgyBO4GrXIAjYyX2DOUqFZhEABYVO1o1v25n6KM3fUO4roFB0srWCvAcKWe8ECRmUAwXdu3Nz6-QBQbCBvmwB9koL8CcXOM_tW20UGlSzmeVI3iu54eKrtL82um7RLPjcRJaSkM2eGfLZK--ZWT5yzRxtp1uL16Zudg5GJ6gOOF3G6t5UuDW68mOmMPOcFxRaN2X5FMStT_l3X8LsAZhfw_xZeDmDg6Ec3vwLAAD__xsOHAI=

# Query with OID expression - don't distribute (#24423).
query BT
EXPLAIN (DISTSQL) SELECT 246::REGTYPE FROM abc
----
false  https://cockroachdb.github.io/distsqlplan/decode.html#eJyMj0FLxDAUhO_-ijAnhYitiIecFK1SqLu17UGRHrLNYyl0k5qXglL632UbRDwIHmcmmfneDH4foJC9lMVtvhGn93nd1M_FmaizIrtrxOXVtVJV9ti8lpl4qLZPQu86SFhnaKMPxFBvSNFKjN51xOz80ZrXB7n5gEokejtO4Wi3Ep3zBDUj9GEgKDR6N1BF2pC_SCBhKOh-WGtH3x-0_7yJi_WoLStxDomKrCGvItw3HdpFwk3hZ4qD3hNUusj_41TEo7NMv0j-ak6WVoLMnuLJ7CbfUeldt85EuV3_rYYhDjFNo8htjJZ2OfkKAAD__3Qhfas=
