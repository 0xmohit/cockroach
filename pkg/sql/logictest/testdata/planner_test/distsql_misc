# LogicTest: 5node-dist

subtest scrub

# Verify the index check execution plan uses a merge join.

statement ok
CREATE TABLE test (k INT PRIMARY KEY, v INT, data INT, INDEX secondary (v) STORING (data))

query T
SELECT url FROM [EXPLAIN (DISTSQL)
    SELECT leftside.v, leftside.k, leftside.data, rightside.v, rightside.k, rightside.data
    FROM
      (SELECT v,k,data FROM test@{FORCE_INDEX=[1]} ORDER BY v,k,data) AS leftside
    FULL OUTER JOIN
      (SELECT v,k,data FROM test@{FORCE_INDEX=[2]} ORDER BY v,k,data) AS rightside
      ON leftside.v = rightside.v AND leftside.k = rightside.k AND leftside.data = rightside.data
    WHERE (leftside.k IS NULL) OR
          (rightside.k IS NULL)
]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJykU01vm0AQvfdXjOYEyrQJYPeAFGnThqiOiEnBUVtFHKiZOsiEdXfXUaMo_70CIgNW7NbtbefjzXtvdvcJ9c8SfUyCMPg4g7Uq4SKOruA2-Hodnk2mYJ1PklnyObThpaXkH0YXOb97oO687J3zzGQEqljcbfq6YNkP6s6WznoZ_kCwJOjyhrURt04KUXwexPDhW6_DhrNkwwoXN2EIl1GteO8sd_esjTCIpmBZnVE47dux4Wx6Dl15OSgv7e16o-B0y7YNXz4FcTAYM0lgehOGNkQxWL2Jm0KKhJXMeZrds0b_Fh1MCVdKzllrqerUU9MwyX-hf0JYVKu1qdMp4VwqRv8JTWFKRh9n2feSY85yVscnSJizyYqyGbtSxX2mHkW9MSRMVlmlfXiLhNHa-CBcEg4JD9NnQrk2HYc22YLRd57p73UkUhlWx85QgnCOSLhHJLyjnTTuITR9u-6QS_NcVvn_GPb-wbC32zDhfWbmd1By5YO7k3W0k7UjW1dS5aw4H7ClNfJPLa9Iv2K14EtZVKyOR0P9s8cV--0vjG5mQdz8RSSs37fVM2efNi97kELCi6I0rHywhDv8B2K8iTfX4VB9Ix6JEYkxifc7NzQ-5F5i1itZad7e1KuTT-r1cL7gdt1artWcr5WcNzRtGDW4JpGzNm3VaYNJ1ZZqgX2wsxc8GoCdbbC7F-ztZ_YOYHa3waO94PEWc_r85ncAAAD__yziDTw=

# Verify the foreign key check execution plan uses a merge join.

statement ok
CREATE TABLE parent (
  id INT PRIMARY KEY,
  id2 INT,
  UNIQUE INDEX (id, id2)
)

statement ok
CREATE TABLE child (
  child_id INT PRIMARY KEY,
  id INT,
  id2 INT,
  FOREIGN KEY (id, id2) REFERENCES parent (id, id2)
)

query T
SELECT url FROM [EXPLAIN (DISTSQL)
    SELECT p.child_id, p.id, p.id2
    FROM
      (SELECT child_id, id, id2 FROM child@{NO_INDEX_JOIN} ORDER BY id, id2) AS p
    FULL OUTER JOIN
      (SELECT id, id2 FROM parent@{FORCE_INDEX=[2]} ORDER BY id, id2) AS c
      ON p.id = c.id AND p.id2 = c.id2
    WHERE (p.id IS NOT NULL OR p.id2 IS NOT NULL) AND
          c.id IS NULL AND c.id2 IS NULL
]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJycUlFvm0wQfP9-xWqfQL4vsc_tC1KkS2uiEhFIsaOmihCi3MY5hQI9DimR5f9ewdlJ7Dpt0weQbnZmd25vVtj-KNHDuR_6HxfQ6RLOkvgCbvzry_A0iMCZBfPF_HPowobSHBV3qpSZkgyao-2fW5mzIT1T7LcpD7BYRXEWRDP_OjuPg2gNcTLzE_jwdct14XQODZxdhSH0jKeuO72aXFNlxA1PDzcoII7A6b3BCRRHSrpwGs0swjcQd-HLJz_xwXEsM5hDFC8gugpDF-Jky34Jb9oUW_oexp_AFBlWtaQo_04tejc4wZRho-uC2rbWPbQaCIF8QG_MUFVNZ3o4ZVjUmtBboVGmJPRwkX8rKaFckj4eI0NJJlfl0NbuOu9MnalK0kN2e58pmWm6zTY7GhjIcN7kVevB_5iuGdadeR7XmnxJ6E3W7N8sTXYt2bm9CyV5dk-PwiJ_44G_6uF5dFfVWpImuTM27ZV_ohy4yAXpJZ3XqiJ9zHcvsnhsyLNJjK8WfjLkERmWdGscwUdMTEfuiVbLO-OIyYgJPnKR4ZkqDWmvj5Xgv4ZKTA8lSrzbz5N4_4Qgw7gzHogJE5yJ6avrm77lCRNqm7pqaX-NBzuP-92RXJJ9i7budEGXui6GMfYYD7oBkNQaW-X2EFRDacjYS_HkDWK-L-a_FU93xON1uv7vZwAAAP__vACG2w==

subtest stats

statement ok
CREATE TABLE data (a INT, b INT, c FLOAT, d DECIMAL, PRIMARY KEY (a, b, c, d))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder FROM [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

query T
SELECT url FROM [EXPLAIN (DISTSQL) CREATE STATISTICS s1 ON a FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEGL2zwQhu_frxBz-goKjmwnm_VpQ5qCIU22kQ-FxQc1GlyDY7mSDG1D_nuxTdgm7MoGp0dLefO8PCPmBOZHARHw9Wa9SkitC_Jpv_tMXtZfnzfLeEv-_xjzhH_ZfCCr_XqZrAlPlknMk3jFiWFktyWiS0hhRQoUSiVxK45oIHoBBhR8oBAAhRAozCClUGl1QGOUbn5yagOx_AnRlEJeVrVtjlMKB6URohPY3BYIESTiW4F7FBK1NwUKEq3IixZT6fwo9K-npgNQ4JUoTUQmHiOilIQRZb-jBgq72kbkiUF6pqBq-8oyVmQIETvT4X24OFYFam923aU75vlvjEhTk1vhhvrvQl9Zdam0RI3yipWe3621zDKNmbBKe2w6smBwVZANnxIbMiWPTTx_1Jx6Gl3mNL_rnPzhGvxBGvyJF4zS0NPoouHhrhqC4RqCQRqCiReO0tDT6KJhcVcN4XAN4SAN4cSbjdLQ0-ii4fGfLa83oHs0lSoN3iyxt_952iw3lBl2m9CoWh_wWatDi-k-d22uPZBobHfLuo-47K6agn-HmTPsX4XZbdh3k3vQgTMdusPhmN4zZ3juJs_HkB-c4YWbvBhDfnTPatrzTNyP7Jadnv_7EwAA___zGAIH


statement ok
INSERT INTO data SELECT a, b, c::FLOAT, 1
FROM generate_series(1,10) AS a, generate_series(1,10) AS b, generate_series(1,10) AS c;

query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) CREATE STATISTICS s1 ON a FROM data]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFvmzAUx-_7FNY7bZIjMJA05VSUMQkpS7rAYVvFwQ1PGRLBzDbauijffQIUdYka8NrkiOH__j_9HvIO1M8CfIjDeThLSC0L8mm1_Ewewq_38yBakGARzL99D8n7j1GcxF_mH8hsFQZJSOIkSKI4iWYxUYwsF4R3yYxrngKFUmS44FtU4D8AAwoOUHCBggcUxpBSqKRYo1JCNp_s2kCU_QbfppCXVa2b45TCWkgEfwc61wWCDwl_LHCFPENp2UAhQ83zoq2pZL7l8umuYQAKccVL5ZORxQgvM8KI0D9QAoVlrX1y10BJ8UsRiTzzCbObaUrzoiA636JPbAXpnoKo9TON0nyD4LM9NSeO-bYqUFrjY9ruOM7_NFUNruYd1rlS52zpc1ddCpmhxOyoK92fxQo2G4kbroW0mP1GQPcIkJnvkZns0WIjyzHZpPP6TQ4wHzY5uegmHXNRjpEoZ2S5VxY1wHwQdXNRUa65KNdIlDuyvCuLGmA-iJpeVJRnLsozEuWNrLGJKPf1ogaYD6Jur3aJvlC6QlWJUuHJZfryZLu5ZDHbYHcjK1HLNd5LsW5rusdlm2sPMlS6e8u6h6jsXjWA_4ZZb9g5CrPTsNPfPFDt9qa9_rD3P9ytxVYoPD5pVERhqZuVpqdjx71jJ_1Mk-sw3fSOnfYzTa_DdNu_eXvgp-v_Zc2p0v27vwEAAP__M3pY9g==
