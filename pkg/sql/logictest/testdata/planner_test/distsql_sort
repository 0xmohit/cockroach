# LogicTest: 5node-dist

statement ok
CREATE TABLE data (a INT, b INT, c INT, d INT, PRIMARY KEY (a, b, c, d))

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into ten parts.
statement ok
ALTER TABLE data SPLIT AT SELECT i FROM generate_series(1, 9) AS g(i)

# Relocate the ten parts to the five nodes.
statement ok
ALTER TABLE data EXPERIMENTAL_RELOCATE
  SELECT ARRAY[i%5+1], i FROM generate_series(0, 9) AS g(i)

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE data]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {2}       2
/2         /3       {3}       3
/3         /4       {4}       4
/4         /5       {5}       5
/5         /6       {1}       1
/6         /7       {2}       2
/7         /8       {3}       3
/8         /9       {4}       4
/9         NULL     {5}       5

# Ensure sort-all strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY d
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE-P2jAUxO_9FNY79Y8jY8ewbE7bdqmERGGbcGhVcXDx0xaJjVPbSK0Q371KgrRlBY4VerTNvJnf4HgP7tcWMph8fZi9n87J6_tpsSy-zN6QYjKbfFySt-RTvvhMtPKKLPL7SU4-fCMaKJRG41w9oYPsO3CgIIBCChQkUBjCikJlzRqdM7b-yb4RTPVvyAYUNmW18_X2isLaWIRsD37jtwgZLNWPLeaoNFo2AAoavdpsG5vKbp6U_XNXpwEKRaVKl5GEcaJKTTgx_idaWB0omJ1_dnBePSJk_EDjUxTGerRseBrgTr67OF5cHP881ViNFvW5oWcyzE1iKsZPS7hkn57Y8_iOeUzHjCdM9Gi5I8ex5VHflkU8pojCFAlLe2B25Dhi3vTFTOMx0yjMNGGyB2ZHjiPmuC-mjMeUUZgyYcMemB05jpi3_-NpODM-R1eZ0mHUVz-o3w3Uj9i-M87s7BofrFk3Nu1y0eiaDY3Ot6e8XUzL9qgO-K-YB8XiRMxfikXYucM6DaplWCyvyT0Mikdh59E1zjdB8TjsPL7G-Tb8Xw06rkn4kr30Xh1e_Q0AAP__Igq-vA==

# Ensure top-k strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY d limit 10
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJyslE9v2jAYxu_7FNZ72h9HxkmgNKduK5MiUegSDpumHDz8qosEcWYbaRPiu09JkDpocSzgGJvHv-f3YnkL5vcKEph8e5x-TGfk7X2aL_Kv03ckn0wnnxfkPfmSzR-IFFaQeXY_ycin70SSafqQLggfAIVKSZyJNRpIfgAHCiFQiIBCDBSGUFCotVqiMUo3P9m2gVT-gWRAoazqjW2WCwpLpRGSLdjSrhASWIifK8xQSNSsAUm0oly1mFqXa6H_3jW1gEJei8okJGCciEoSTpT9hRqKHQW1sc8EY8UTQsJ31L9FrrRFzYaHBe7iD0BhWq5L20zhFCk8SXoGKC1Ro3x5frF7pc5MBapm_GgevUWigyLcf_DcZ_CMByw8Y_Q9PfajH11h9KG_cehlHAYsOsO4p8fe-OYKxpG_ceRlHAUsPsO4p8feeHwF49jfOPYyjgM2PMO4p8fe-PbKD8orpAxNrSqDB6RTJw-a1wblE3avk1EbvcRHrZYtpvuct7l2QaKx3S7vPtKq22oK_h_mznB4EObH4dBN7kFHznTsDseX9B46wyM3eXQJ-cYZHrvJ40vIt-7_atBzTdyX7Jhd7N78CwAA__8Fv9JQ

# Ensure chunk strategy is used
query BT
EXPLAIN(DISTSQL) SELECT * FROM data ORDER BY a, c
----
true  https://cockroachdb.github.io/distsqlplan/decode.html#eJy0lEFv2jAUx-_7FNY7basj4yS0NCe2lUlIDLqEw6YpBy9-apFCnNlG2oT47lMSpI4KHAvYMTZ__f6_h_W2YH6VkMDk2-Psw3RO3j5Ms2X2dfaOZJPZ5NOSvCef08UXIoUVZJE-TFLy8TsRlBRAoVIS52KNBpIfwIFCCBQioBADhSHkFGqtCjRG6eYn2zYwlb8hGVBYVfXGNsc5hUJphGQLdmVLhASW4meJKQqJmg2AgkQrVmWLqfVqLfSfcVMIKGS1qExCAsaJqCThRNln1JDvKKiNfSEYK54QEr6j_i0ypS1qNjwsMOY3dBzdAIW1sMUzKbFKCD9JDE8SX0BKS9Qoj3Py3ZFqcxWomvHD2ZyqEB1U4P6j5z6jZzxg4RnD7-mxH_7tFYcf-puHXuZhwKIzzHt67M3vrmge-ZtHXuZRwOIzzHt67M1HVzSP_c1jL_M4YMMzzHt67M3v_9OqOUJM0dSqMui1QQbNDkL5hN3eMmqjC3zUqmgx3eeizbUHEo3tbnn3Ma26q6bgv2HuDIcHYf46HLrJPejImY7d4fiS3kNn-NZNvr2EfOcMj9zk0SXke_d_Neh5Ju5H9pqd7978DQAA__8aFtoV
