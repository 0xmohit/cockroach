# LogicTest: 5node-dist

# These tests are different from explain_analyze because they require manual
# data placement and are run without the optimizer.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT)

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT)

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Prevent the merge queue from immediately discarding our splits.
statement ok
SET CLUSTER SETTING kv.range_merge.queue_enabled = false;

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames
SELECT start_key, end_key, replicas, lease_holder from [SHOW EXPERIMENTAL_RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzcWF1v4jgUfd9fYfmp1YRJ7IR-RBqJzmx3xSyFbmml7Y5QlTZeivgI64R2qqr_fZXADjSBXLsYO9M3Epzcc09uTo7PM47_HWEfd09bp18u0YyP0G8XnTP07fSv89ZJs41O2iet679P0d6vze5l98_WPlosHT58HFooeOjvDR8_Dvfnlw0f0NdOs42Gj6jTzpagTyj9H_1-0bk6R5-vs5M9bOFJFLJ2MGYx9r9hgi1MsYVdbGEPW7iOexae8uiOxXHE0yXP2QXN8Dv2HQsPJtNZkp7uWfgu4gz7zzgZJCOGfXwZ3I7YBQtCxm0HWzhkSTAYZWWmfDAO-FNj-IAt3J0Gk9hHNTst3JklPmqkMHj0GCPOgtBH6WGcBKMRSgZj5iMnxr0XC0ezZFF9WfT2Cd0H8f3rcg2Cey-97B59hn3yYr2ti4MNXTwuu7CJvj7oxj6W94l4yDgL8_f5kBYWWrWGkjPG--xrNJgwbpPckx2xf5K9Bvmw_4kP-vfzn0s6rEbKTboG5WjJzuW4sXB2j_zS-cnC2nHwHY3ZOOJPaBaz0EfUQX8MPucYXrLnykzBSb_PWT9IIm6TeuGhWLgzJ3DxyE_a1zftzuVN-6rV2muQlIDu1dleg6a_vnSu2peL3-WzsaYnsq4nuanxtpuacnKosx053auzm2ZKj5seXbBJyHg2OKhB7YarjLIlHXUBOmaTdYSs5aId1aKpTeu5letrH7yqTcSFiMByatOa7RoRVIk-DgUEVWMfdGMfGgWVbC-ojrigOhKC6iBRNQVGYFVND3aipo6QNBQb2kZKpecFkFKiUUrfytcmHaXiGkAFtMyt2Z4RLZPo40hAyzT2QTf2oVHL6DvQMmAEVrXs8N1omfS8AFpGf2Itc8U1wBXQMq9m141omUQfxwJaprEPurEPjVrmbq9lnriWebva6AJTsCpnRzuRM8_MRld6agBFczUq2haUbRI1T1wMPAFRq9eMSJpEF3VY0mo2QcEkRARFyT3jRsTNMyNu3jswasAwrCrb8bsxatLzAsia9xMbNSDDvWDxNJrETCiac1KiWNhnc2LjaMbv2DmP7rIy88NOdl228Q9ZnMz_pfOD5uT_v-IkyO696DyaJWzRe7HVxclwEA9_nMpecfH6R6rrW_j2KWExitkkeQMe4lYNkCBDRBcgqp8hIjHCdAcjXF7_SHX9LfnIjXAFAAkypHCEgYnRzxDNA3JWAb3G4-Qvdku78VQLRAF8eX3iaBcEAFC9YoBo1Rii-hnySl-AHJ78xfXSi-nB69dnB1-AA70mCmSzHI9yUyVZ34CJAgDpN1HAxOhn6FCvidoSj3JTJVnfgIkCAOk3UcDE6GfoqPQzcFxuoo5VmCiFzZTjUW-qZAHotwjlgAyYKACQfoZIYWte5qJWAEH3ldlha2lUZstdAUDqHY80Av0WB5oaA0FRYZtt2OQAgAxER-WA1NseaQQGwiJgagzkaYXt-yudJ1651SGFzbZhrwMAMpAgQYiUf9tlERiwOxAiA36nPPh5u9-pWp4DADLgdyqX8ECIlPsf6akxwEnVQh0AkAG_U7mYB0Kk3P9IT40BTsqTHQJEO6Rq2Q4AyITfqVzaAyAS9T_eFu9B5fIduqN8hyrJdxRuuQBA-v0OAMiA34EQVY4j9f6niEBJvqNyjquW7wCADPgdCFHlOFLvf4oIyvMdCuQ7tGr5DgDIgN-BEBn4tlcu74EQ7T4Do6rynd7LL_8FAAD__5Tlq-M=

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzkWNFuozgUfd-vsPw01ZIBG2hTpJHaTrPazHaT2aQPOzvKAw3eBiWBLCbNVFX_fQVJlEJSX9NQG2neSuDicy_H5_j0CfP_ZtjDw85N5_MtWiYz9Nug_yf63vn7681lt4cue5c33_7poA_X3eHt8K-bE7R5NLvu9j7fog_T1cfVybps-oC-9Ls9NF2hfg9NHz5O0SeU3Uf9wXVngK6-5VcjbOAoDljPnzOOve-YYANTbGAbG9jBBnbxyMCLJB4zzuMke-QpL-gGP7BnGTiMFss0-3lk4HGcMOw94TRMZwx7-Na_m7EB8wOWmBY2cMBSP5zlyyyScO4njxfTB2zg4cKPuIdaZrZwf5l66CKDkcQrjhLmBx7KLnnqz2YoDefMQxbHo2cDx8t0s_pu0btHNPH5pLjcBcGj51H-jnuGPfJsvK2L01e6WO26MMnLPui79kFf7WP3nmUUJwFLWFB40yirhB45MIzffT75EocRS0xS-qQz9m_64YKcfErC-0n-V2EK2W1UGkX-W2keBs7ry4-uf9x7lqdxwgLEw4B5KH8GG3ju_0BzNo-TR7TkLPAQtdAf4dXmThDy6eZ3C12V5r-brV2FI8M4SbORuOXP9Sv4_Q_AJW-A61SBex3yNIzGqUmtPX4ZuL8mg9QuPIBehNKVIOwhLuaTPEjIXSt7sxe14h7dymmhFSKvIQRWQpO2TFuLFlbo40xCCwt9qNRColgLyVFaaMlroSWphdnrXqP0EToI8GOrg6eADlrS2-8IEQSw7pSDVFEOeehyIkjldxyVUA67ZTpalKNCH20J5Sj0oVI5qGLloD-JcgD82CrHWROUA8C6Uw6qUzls-R1nSyiH0zJdLcpRoY9zCeUo9KFSOWzFymEfpRyOvHI4-vMXwJGterQB9XAU5S8A7k5A7CoCIodeXkAc-Y3nSAiI29IiHxW6cGH5aJkE-VGACIrTCUu0CImjWEicn-QIAjBlKyLnTTiCAFh3CuLoPIIA_2caML6II87KjD34ZiujKQvu2Zr2PF4mY_Y1icf5MuvLfl6XR7uA8XR9l64vutH2Fk_9_N2bzuNlyja977d64BvhfE_Jr9-ue30D3z2mjCPOovQNeIjdNECSEyKqAFH1EyIVKEzfgcLi9dt1r3_kPEoUbgAgyQnVSGGAMeonRMuArJeAiniscrEtLHbExY6w2C1u5nKxKyymp8Wl32Hrnap1L_A7ivHU7mYV19fgXgAg9e4FMEb9hM7UuteReGp3s4rra3AvAJB69wIYo35CbaENnIsN6FxYTCxxNdk7jYr868UsoBNClUOlkkNulVNmAwDV7zWVEag3F4g1GrLR3slSs70AgDSkJTGg-g2nMgIN-QhgjYYIKQ45BEg5RBxziAuUi4PO212mafkFAKTBZRqXaCBEtbtOZdZomEnTQgwASIPLNC7WQIhqd53KrNEwE3GSIUCUIeIsQ4EsQ98py9BaskyNxwsAkHqXAQBpcBkIUeNmVL_r7COoJcvUyeOmZRkAkAaXgRA1bkb1u84-AnGWoUCWoeIsQ4EsQ-vKMqPnX_4PAAD__0vu5ys=

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0UUFv2kwQvX-_YjSnr9VW2AZ62JNJQxW3FFJAatPIh413Slasve7uOg1C_PcKGynBKRRU9Thv3ps3M2-N7odGjrPhaPhuDpXV8H46-QS3w6_Xo0EyhsF4MLr5NoT_L5PZfPZ59Ap21NcNcfkAX5L5FUyml8l4MErmNzCYgWAHGncpMiyMpLHIySG_xRBThqU1GTln7BZa14REPiIPGKqirPwWThlmxhLyNXrlNSHHubjTNCUhyXYCZCjJC6XrsaVVubCrePmADGelKByHN8jQmp8OLAnJoY8MnRdag1c5cQgcphuGpvJPjs6LBSEPN-z0rbTJhAZjpSqEVn4FQSfcW-6QS3SOy_Pbo395e_evbg873ZNu7x10eRpeFcZKsiTbE_9M-c2qV8LdfzCqINvp7f9vUnkOccjiiMVdFvdY3GfxW2So6buH1hdrrPVKhlYt7l9QG_AF13ljSYJTkjjUHGSYi0fIKTd2BZUjySEK4KO62HWkcssdHsDFwej650Q3JVeawtFJcQXbj5JcUJOQM5XN6NqarLZpykmtqwFJzjfdsCmSomltF3wuDo-Ke3visC2Ojoq7x527ZzhHbXHvqLjfck43__0KAAD__zhOxds=

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0UUFv2kwQvX-_YjSnr9VW2AZ62JNJQxW3FFJAatPIh413Slasve7uOg1C_PcKGynBKRRU9Thv3ps3M2-N7odGjrPhaPhuDpXV8H46-QS3w6_Xo0EyhsF4MLr5NoT_L5PZfPZ59Ap21NcNcfkAX5L5FUyml8l4MErmNzCYgWAHGncpMiyMpLHIySG_xRBThqU1GTln7BZa14REPiIPGKqirPwWThlmxhLyNXrlNSHHubjTNCUhyXYCZCjJC6XrsaVVubCrePmADGelKByHN8jQmp8OLAnJoY8MnRdag1c5cQgcphuGpvJPjs6LBSEPN-z0rbTJhAZjpSqEVn4FQSfcW-6QS3SOy_Pbo395e_evbg873ZNu7x10eRpeFcZKsiTbE_9M-c2qV8LdfzCqINvp7f9vUnkOccjiiMVdFvdY3GfxW2So6buH1hdrrPVKhlYt7l9QG_AF13ljSYJTkjjUHGSYi0fIKTd2BZUjySEK4KO62HWkcssdHsDFwej650Q3JVeawtFJcQXbj5JcUJOQM5XN6NqarLZpykmtqwFJzjfdsCmSomltF3wuDo-Ke3visC2Ojoq7x527ZzhHbXHvqLjfck43__0KAAD__zhOxds=

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJy0k0-P2jAQxe_9FKM5gWSUv_TgE7SlFSqFLaDtn1UOXjxCEUmc2g67CPHdqziVttmybSrBcWy_eb838hzR_MiQ42oym7xdQ6UzeL9cfIK7ydeb2Xg6h_F8PPv2fQK9d9PVevV51odfT8V-29v1YXE7WUKv36h2-wQZFkrSXORkkN9hgAxDZBghwxgZDjFhWGq1IWOUrp8cnWAqH5H7DNOirGx9nDDcKE3Ij2hTmxFyXIv7jJYkJGnPR4aSrEgzZ1PqNBf6MNrtkeGqFIXhMPBq40VlOYxqDK0eDGgSkkNdGiuyDGyaEwffYHJiqCr75G6s2BLy4MReIHwCqwqlJWmSLajkdCbDl7SQ6oG0N2wHGN9-6I2Cfhtz-Ccmw1w8Qk650geoDEkOkQ8f0zcvBghbAYLuIw7-PWIvHHjRxYccdmcMOzBGAy--OGPUnTHqwBgP3Ie4LGPcnTHuwDgcXHWdzhAuyZSqMPRsrc539ut1I7mlZjeNqvSGbrTaOJumXDidO5BkbHMbNMW0cFcO8Hdx8Ffx65bYfy4O_8fZRXGp8P5gyYChwnLw62G220bXaRtfp-3wQm2T06ufAQAA__87ViNQ

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkM1q4zAUhffzFJczmxnQYHsrGEhoXWpwk9QO9Cd4oVqXYKxYriSnLcHvXmIXSheFLs-Pjj7uCf7ZQKJM8_RiS4MzdFWsb2iX3m_yZbai5WqZPzym9OcyK7flbf6XPqrtXGyPdHedFim19J_iCgKd1bxSB_aQOySoBHpna_beurN1mgqZfoWMBZquH8LZrgRq6xjyhNAEw5DYqifDBSvNLoohoDmoxkyzvWsOyr0t2iMEyl51XlIU_4vi6DcE1kOQtEgg4OyLJ8dKSzov-KCModAcWFLsUY0CdgifBD6oPUMmo_g5ZcG-t53nL4DfLcdjJcB6z_MlvB1czRtn6-mbWa6nd5Oh2Yc5TWaRdXM0VuOv9wAAAP__ki2Ljg==
